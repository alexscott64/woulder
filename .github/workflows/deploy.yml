name: Deploy Woulder

on:
  push:
    branches: [master]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Build Go backend for Linux
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build backend
        run: |
          cd backend
          GOOS=linux GOARCH=amd64 go build -o woulder-api ./cmd/server

      # Build frontend
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        run: |
          cd frontend
          npm run build
        env:
          VITE_API_URL: https://woulder.com/api

      # Deploy to VPS
      - name: Set up SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy backend
        run: |
          # Stop existing service
          ssh -i ~/.ssh/id_ed25519 root@${{ secrets.VPS_HOST }} "systemctl stop woulder || true"

          # Upload new binary
          scp -i ~/.ssh/id_ed25519 backend/woulder-api root@${{ secrets.VPS_HOST }}:/opt/woulder/woulder-api

          # Make executable and start
          ssh -i ~/.ssh/id_ed25519 root@${{ secrets.VPS_HOST }} "chmod +x /opt/woulder/woulder-api && systemctl start woulder"

      - name: Deploy frontend
        run: |
          # Clear old frontend files
          ssh -i ~/.ssh/id_ed25519 root@${{ secrets.VPS_HOST }} "rm -rf /var/www/woulder/*"

          # Upload new frontend
          scp -i ~/.ssh/id_ed25519 -r frontend/dist/* root@${{ secrets.VPS_HOST }}:/var/www/woulder/

      - name: Verify deployment
        run: |
          sleep 5
          # Try HTTPS first, fall back to HTTP (in case SSL isn't set up yet)
          curl -f --max-time 10 https://woulder.com/api/health 2>/dev/null || \
          curl -f --max-time 10 http://woulder.com/api/health 2>/dev/null || \
          echo "Health check pending - run 'certbot --nginx -d woulder.com -d www.woulder.com' on VPS for HTTPS"
